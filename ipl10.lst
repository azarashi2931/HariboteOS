     1 00000000                                 ; hello-os
     2 00000000                                 ; TAB = 4
     3 00000000                                 ; DB data byte,1byte指定書き込み
     4 00000000                                 ; DW data word,2byte指定書き込み
     5 00000000                                 ; DD data double-word,4バイト指定書き込み
     6 00000000                                 ; RESB reserve byte,指定数分予約,0で埋める
     7 00000000                                 ; MOV 代入命令
     8 00000000                                 ; ORG メモリのどこに読み込まれるかを取得
     9 00000000                                 ; ADD 加算命令
    10 00000000                                 ; [xxx] xxxをメモリアドレスとして扱う
    11 00000000                                 ; JMP 指定されたタグにジャンプ
    12 00000000                                 ; CMP 比較命令,真の場合の処理が後に続く
    13 00000000                                 ; JE jump if equal 前の比較命令が真のとき指定されたタグにジャンプ
    14 00000000                                 ; INT interrupt 割り込み命令
    15 00000000                                 ; HLT cpu待機命令 省エネ halt:停止
    16 00000000                                 
    17 00000000                                 ; EQU =,代入演算子？
    18 00000000                                 
    19 00000000                                 ; 定数定義みたいなもの
    20  = 0000000A                              CYLS	EQU		10				; どこまで読み込むか
    21 00000000                                 
    22 00000000                                 
    23                                                  ORG     0x7c00              ; このプログラムがどこに読み込まれるか,0x7c00はブートセクタが読み込まれるアドレス
    24 00007C00                                 
    25 00007C00                                 ; 標準的なFAT12フォーマットのフロッピーディスク用の記述
    26 00007C00 EB 4E                                   JMP     entry
    27 00007C02 90                                      DB      0x90
    28 00007C03 48 41 52 49 42 4F 54 45                 DB      "HARIBOTE"          ; ブートセクタの名称、自由、8byte
    29 00007C0B 0200                                    DW      512                 ; 1セクタの大きさ(512byteにしなければならない)
    30 00007C0D 01                                      DB      1                   ; クラスタの大きさ(1セクタにしなくてはならない)
    31 00007C0E 0001                                    DW      1                   ; FATがどこから始まるか(普通は1セクタ目からにする)
    32 00007C10 02                                      DB      2                   ; FATの個数(2にしなければならない)
    33 00007C11 00E0                                    DW      224                 ; ルートディレクトリの大きさ(普通は224エントリにする)
    34 00007C13 0B40                                    DW      2880                ; このドライブの大きさ(2880セクタにしなくてはならない)
    35 00007C15 F0                                      DB      0xf0                ; メディアのタイプ(0xf0にしなくてはならない)
    36 00007C16 0009                                    DW      9                   ; FAT領域の長さ(9セクタにしなくてはならない)
    37 00007C18 0012                                    DW      18                  ; 1トラックにいくつのセクタがあるか(18にしなければいけない)
    38 00007C1A 0002                                    DW      2                   ; ヘッドの数(2にしなくてはいけない)
    39 00007C1C 00000000                                DD      0                   ; パーティションを使っていないのでここでは必ず0
    40 00007C20 00000B40                                DD      2880                ; このドライブの大きさをもう一度書く
    41 00007C24 00 00 29                                DB      0,0,0x29            ; よく分からない、この値にしておくといいらしい
    42 00007C27 FFFFFFFF                                DD      0xffffffff          ; たぶんボリュームのシリアル番号
    43 00007C2B 48 41 52 49 42 4F 54 45 2D 4F           DB      "HARIBOTE-OS"       ; ディスクの名前(11byte)
       00007C35 53 
    44 00007C36 46 41 54 31 32 20 20 20                 DB      "FAT12   "          ; フォーマットの名前(8byte)
    45 00007C3E 00 00 00 00 00 00 00 00 00 00           RESB    18                  ; とりあえず18byte空けておく
       00007C48 00 00 00 00 00 00 00 00 
    46 00007C50                                 
    47 00007C50                                 ; プログラム本体
    48 00007C50                                 
    49 00007C50                                 entry:
    50 00007C50 B8 0000                                 MOV     AX, 0               ; レジスタの初期化,DB      0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
    51 00007C53 8E D0                                   MOV     SS, AX              ;DB      0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
    52 00007C55 BC 7C00                                 MOV     SP, 0x7c00          ;DB      0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
    53 00007C58 8E D8                                   MOV     DS, AX              ;DB      0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
    54 00007C5A                                 
    55 00007C5A                                 ; ディスクを読み込む
    56 00007C5A                                 
    57 00007C5A B8 0820                                 MOV     AX, 0x0820
    58 00007C5D 8E C0                                   MOV     ES, AX              ; バッファアドレス(読み込み先のメモリの大まかなアドレス)
    59 00007C5F B5 00                                   MOV     CH, 0               ; シリンダ0(年輪的なアレ)
    60 00007C61 B6 00                                   MOV     DH, 0               ; ヘッド0(フロッピーディスクの表裏)
    61 00007C63 B1 02                                   MOV     CL, 2               ; セクタ2(片方のヘッドのあるシリンダを18等分したもの=1セクタ)
    62 00007C65                                 readloop:
    63 00007C65 BE 0000                                 MOV     SI, 0               ; 失敗回数を数えるレジスタ
    64 00007C68                                 retry:
    65 00007C68 B4 02                                   MOV     AH, 0x02            ; AH = 0x02 : ディスク読み込み
    66 00007C6A B0 01                                   MOV     AL, 1               ; 1セクタ
    67 00007C6C BB 0000                                 MOV     BX, 0               ; バッファアドレス(読み込み先のメモリの詳細なアドレス)
    68 00007C6F B2 00                                   MOV     DL, 0x00            ; Aドライブ(0番のドライブ)
    69 00007C71 CD 13                                   INT     0x13                ; ディスクbios呼び出し
    70 00007C73 73 10                                   JNC     next                 ; errorがなければnextへ
    71 00007C75 83 C6 01                                ADD     SI, 1               
    72 00007C78 83 FE 05                                CMP     SI, 5               ; SIと5を比較
    73 00007C7B 73 35                                   JAE     error               ; SIが5以上ならerrorへ
    74 00007C7D B4 00                                   MOV     AH, 0x00
    75 00007C7F B2 00                                   MOV     DL, 0x00            ; Aドライブ
    76 00007C81 CD 13                                   INT     0x13                ; システムのリセット
    77 00007C83 EB E3                                   JMP     retry
    78 00007C85                                 next:
    79 00007C85 8C C0                                   MOV     AX, ES              ; アドレスを0x20進める,0x20 = 512/16
    80 00007C87 05 0020                                 ADD     AX, 0x0020              ; ADD ES,0x0020ができないのでこうやっている
    81 00007C8A 8E C0                                   MOV     ES, AX                  ; 
    82 00007C8C 80 C1 01                                ADD     CL, 1
    83 00007C8F 80 F9 12                                CMP     CL, 18              ; セクタ番号が格納されたCLと18を比較
    84 00007C92 76 D1                                   JBE     readloop            ; CLが18以下ならreadloopへ
    85 00007C94 B1 01                                   MOV     CL, 1
    86 00007C96 80 C6 01                                ADD     DH, 1
    87 00007C99 80 FE 02                                CMP     DH, 2               ; DHと2を比較
    88 00007C9C 72 C7                                   JB      readloop            ; DH < 2の時readloopへ
    89 00007C9E B6 00                                   MOV     DH, 0
    90 00007CA0 80 C5 01                                ADD     CH, 1
    91 00007CA3 80 FD 0A                                CMP     CH, CYLS
    92 00007CA6 72 BD                                   JB      readloop            ; CH < CYLSならreadloop
    93 00007CA8                                 
    94 00007CA8                                 ; ここまでフロッピディスクのロード,ロードが完了したのでOS本体のアドレスにジャンプ(アドレスはバイナリエディタで確認)
    95 00007CA8                                 
    96 00007CA8 88 2E 0FF0                              MOV     [0x0ff0], CH        ; IPLがどこまで読んだかメモ
    97 00007CAC E9 4551                                 JMP     0xc200              ; 0x8000(ブートセクタの先頭) + 0x4200(イメージファイル内のOS本体のアドレス(ローカルアドレス？)) = 0xc200
    98 00007CAF                                 
    99 00007CAF                                 ; 読み込み後はやることが無いのでとりあえず待機
   100 00007CAF                                 fin:
   101 00007CAF F4                                      HLT                         ; 何かあるまでCPUを停止
   102 00007CB0 EB FD                                   JMP fin                     ; 無限ループ
   103 00007CB2                                 
   104 00007CB2                                 error:
   105 00007CB2 BE 7CC7                                 MOV SI, msg
   106 00007CB5                                 
   107 00007CB5                                 putloop:
   108 00007CB5 8A 04                                   MOV     AL, [SI]
   109 00007CB7 83 C6 01                                ADD     SI, 1               ; SIに1加算
   110 00007CBA 3C 00                                   CMP     AL, 0
   111 00007CBC 74 F1                                   JE      fin
   112 00007CBE B4 0E                                   MOV     AH, 0x0e            ; 1文字表示ファンクション,ここ間違えあたら変な表示になった
   113 00007CC0 BB 000F                                 MOV     BX, 15              ; カラーコード
   114 00007CC3 CD 10                                   INT     0x10                ; ビデオbios呼び出し
   115 00007CC5 EB EE                                   JMP     putloop
   116 00007CC7                                         
   117 00007CC7                                 msg:
   118 00007CC7 0A 0A                                   DB      0x0a, 0x0a          ; 改行2つ
   119 00007CC9 6C 6F 61 64 20 65 72 72 6F 72           DB      "load error!"
       00007CD3 21 
   120 00007CD4 0A                                      DB      0x0a                ; 改行1つ
   121 00007CD5 00                                      DB      0
   122 00007CD6                                         
   123 00007CD6 00 00 00 00 00 00 00 00 00 00           RESB    0x7dfe-$            ; 0x7dfe - 現在のアドレス => 0x1feまで予約
       00007CE0 00 00 00 00 00 00 00 00 00 00 
       00007CEA 00 00 00 00 00 00 00 00 00 00 
       00007CF4 00 00 00 00 00 00 00 00 00 00 
       00007CFE 00 00 00 00 00 00 00 00 00 00 
       00007D08 00 00 00 00 00 00 00 00 00 00 
       00007D12 00 00 00 00 00 00 00 00 00 00 
       00007D1C 00 00 00 00 00 00 00 00 00 00 
       00007D26 00 00 00 00 00 00 00 00 00 00 
       00007D30 00 00 00 00 00 00 00 00 00 00 
       00007D3A 00 00 00 00 00 00 00 00 00 00 
       00007D44 00 00 00 00 00 00 00 00 00 00 
       00007D4E 00 00 00 00 00 00 00 00 00 00 
       00007D58 00 00 00 00 00 00 00 00 00 00 
       00007D62 00 00 00 00 00 00 00 00 00 00 
       00007D6C 00 00 00 00 00 00 00 00 00 00 
       00007D76 00 00 00 00 00 00 00 00 00 00 
       00007D80 00 00 00 00 00 00 00 00 00 00 
       00007D8A 00 00 00 00 00 00 00 00 00 00 
       00007D94 00 00 00 00 00 00 00 00 00 00 
       00007D9E 00 00 00 00 00 00 00 00 00 00 
       00007DA8 00 00 00 00 00 00 00 00 00 00 
       00007DB2 00 00 00 00 00 00 00 00 00 00 
       00007DBC 00 00 00 00 00 00 00 00 00 00 
       00007DC6 00 00 00 00 00 00 00 00 00 00 
       00007DD0 00 00 00 00 00 00 00 00 00 00 
       00007DDA 00 00 00 00 00 00 00 00 00 00 
       00007DE4 00 00 00 00 00 00 00 00 00 00 
       00007DEE 00 00 00 00 00 00 00 00 00 00 
       00007DF8 00 00 00 00 00 00 
   124 00007DFE                                 
   125 00007DFE 55 AA                                   DB      0x55, 0xaa